<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>提款審核與協作 - 原型</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', 'Noto Sans TC', sans-serif;
            background-color: #f8fafc;
        }
        .status-pending { background-color: #fffbeb; color: #b45309; border: 1px solid: #fef3c7;}
        .status-reviewing { background-color: #e0f2fe; color: #0284c7; border: 1px solid #bae6fd; }
        .status-review-failed { background-color: #fee2e2; color: #dc2626; border: 1px solid #fecaca; }
        .status-processing { background-color: #ede9fe; color: #7c3aed; border: 1px solid #ddd6fe; }
        .status-success { background-color: #dcfce7; color: #16a34a; border: 1px solid #bbf7d0; }
        .status-failed { background-color: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .status-auto { background-color: #ecfdf5; color: #059669; border: 1px solid #a7f3d0; }
        .tag-overdue { background-color: #fef2f2; color: #ef4444; }

        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; align-items: center; justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background-color: white; padding: 2rem; border-radius: 0.5rem;
            width: 90%; max-width: 550px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }

        .toast {
            position: fixed; top: 20px; right: 20px;
            padding: 1rem 1.5rem; border-radius: 0.5rem; color: white;
            opacity: 0; transition: opacity 0.3s, transform 0.3s;
            transform: translateY(-20px); z-index: 100;
        }
        .toast.show { opacity: 1; transform: translateY(0); }
        .toast-success { background-color: #22c55e; }
        .toast-error { background-color: #ef4444; }
        .toast-info { background-color: #3b82f6; }
        .disabled-btn { cursor: not-allowed; background-color: #e5e7eb; color: #9ca3af; }
    </style>
</head>
<body class="p-4 md:p-8">

    <div class="max-w-screen-xl mx-auto bg-white rounded-lg shadow-md p-6">

        <header class="pb-4 border-b border-gray-200 mb-6">
            <h1 class="text-2xl font-bold text-gray-800">提款審核 (出金查詢)</h1>
            <p class="text-sm text-gray-500 mt-1">審核玩家出金申請，確保金流安全與合規。</p>
        </header>

        <!-- 搜尋區塊 -->
        <div id="search-filters" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 rounded-lg">
            <!-- 搜尋目標 & 內容 -->
            <div class="md:col-span-2 grid grid-cols-3 gap-2">
                <div class="col-span-1">
                    <label for="searchField" class="block text-sm font-medium text-gray-700 mb-1">搜尋目標</label>
                    <select id="searchField" class="w-full border-gray-300 rounded-md shadow-sm text-sm">
                        <option value="transactionId">交易流水號</option>
                        <option value="userId">玩家ID</option>
                    </select>
                </div>
                <div class="col-span-2">
                    <label for="searchInput" class="block text-sm font-medium text-gray-700 mb-1 invisible">搜尋內容</label>
                    <input type="text" id="searchInput" placeholder="請輸入資料" class="w-full block rounded-md border-gray-300 text-sm">
                </div>
            </div>
            <!-- 狀態 -->
            <div>
                <label for="statusFilter" class="block text-sm font-medium text-gray-700 mb-1">狀態</label>
                <select id="statusFilter" class="w-full border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="all">全部</option>
                    <option value="待審核">待審核</option>
                    <option value="審核中">審核中</option>
                    <option value="審核失敗">審核失敗</option>
                    <option value="系統出款中">系統出款中</option>
                    <option value="系統出款成功">系統出款成功</option>
                    <option value="系統出款失敗">系統出款失敗</option>
                    <option value="自動提款">自動提款</option>
                </select>
            </div>
            <!-- 出款方式 -->
            <div>
                <label for="paymentMethodFilter" class="block text-sm font-medium text-gray-700 mb-1">出款方式</label>
                <select id="paymentMethodFilter" class="w-full border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="all">全部</option>
                    <option value="Gcash">Gcash</option>
                    <option value="後台">後台</option>
                </select>
            </div>
            <!-- 首提 -->
            <div>
                <label for="firstWithdrawalFilter" class="block text-sm font-medium text-gray-700 mb-1">首提</label>
                <select id="firstWithdrawalFilter" class="w-full border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="all">全部</option>
                    <option value="yes">首提</option>
                    <option value="no">非首提</option>
                </select>
            </div>
            <!-- 訂單標記 -->
            <div>
                <label for="tagFilter" class="block text-sm font-medium text-gray-700 mb-1">訂單標記</label>
                <select id="tagFilter" class="w-full border-gray-300 rounded-md shadow-sm text-sm">
                    <option value="all">全部</option>
                    <option value="overdue">逾時訂單</option>
                </select>
            </div>
            <!-- 時間 -->
            <div class="md:col-span-2 grid grid-cols-2 gap-2">
                 <div>
                    <label for="startDate" class="block text-sm font-medium text-gray-700 mb-1">申請時間 (起)</label>
                    <input type="datetime-local" id="startDate" class="w-full border-gray-300 rounded-md shadow-sm text-sm">
                </div>
                <div>
                    <label for="endDate" class="block text-sm font-medium text-gray-700 mb-1">申請時間 (迄)</label>
                    <input type="datetime-local" id="endDate" class="w-full border-gray-300 rounded-md shadow-sm text-sm">
                </div>
            </div>
            <!-- 按鈕 -->
            <div class="col-span-1 md:col-span-2 lg:col-span-4 flex items-end justify-between space-x-2 mt-2">
                <div>
                    <button id="exportCsvButton" class="bg-gray-300 text-gray-500 font-semibold py-2 px-4 rounded-md shadow-sm disabled-btn" disabled>
                        匯出CSV
                    </button>
                </div>
                <div class="flex-grow flex justify-end">
                    <button id="searchButton" class="w-full max-w-xs bg-indigo-600 text-white font-semibold py-2 px-4 rounded-md shadow-sm hover:bg-indigo-700">
                        搜尋
                    </button>
                </div>
            </div>
        </div>

        <!-- 統計與列表 -->
        <div class="mb-4 flex space-x-4">
            <div class="text-sm font-medium">統計資料 |</div>
            <div class="text-sm">審核中: <span id="reviewing-count" class="font-bold text-blue-600">0</span></div>
            <div class="text-sm">待審核: <span id="pending-count" class="font-bold text-amber-600">0</span></div>
        </div>

        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">審核功能</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer" id="status-sort">狀態 ↓</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">訂單標記</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">交易流水號</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">玩家ID</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">首提</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">申請時間</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">提現申請金額</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">實際出款金額</th>
                        <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">操作人</th>
                    </tr>
                </thead>
                <tbody id="applications-table-body" class="bg-white divide-y divide-gray-200"></tbody>
            </table>
        </div>
    </div>

    <!-- 審核 Modal -->
    <div id="reviewModal" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-xl font-bold mb-6 text-gray-800">提款審核</h2>
            <div class="space-y-4 text-sm">
                <p><span class="font-semibold text-gray-600 w-28 inline-block">交易流水號:</span> <span id="modal-transactionId" class="text-gray-900"></span></p>
                <p><span class="font-semibold text-gray-600 w-28 inline-block">申請時間:</span> <span id="modal-applicationTime" class="text-gray-900"></span></p>
                <p><span class="font-semibold text-gray-600 w-28 inline-block">玩家ID:</span> <span id="modal-userId" class="text-gray-900"></span></p>
                <p><span class="font-semibold text-gray-600 w-28 inline-block">是否首提:</span> <span id="modal-isFirst" class="text-gray-900"></span></p>
                <p><span class="font-semibold text-gray-600 w-28 inline-block">提現申請金額:</span> <span id="modal-amount" class="text-red-600 font-bold"></span></p>
                <div>
                    <label for="review-remark" class="block font-semibold text-gray-600 mb-1">審核說明</label>
                    <textarea id="review-remark" rows="3" class="w-full border-gray-300 rounded-md shadow-sm text-sm" placeholder="可輸入簡短說明 (最多255字)"></textarea>
                    <p id="remark-char-count" class="text-xs text-gray-500 text-right mt-1">0 / 255</p>
                </div>
            </div>
            <div class="mt-8 grid grid-cols-2 gap-3">
                <button id="approveBtn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">通過審核</button>
                <button id="rejectBtn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700">退回審核</button>
                <button id="cancelReviewBtn" class="w-full px-4 py-2 bg-gray-500 text-white rounded-md hover:bg-gray-600">取消審核</button>
                <button id="closeBtn" class="w-full px-4 py-2 bg-white text-gray-700 border border-gray-300 rounded-md hover:bg-gray-50">關閉</button>
            </div>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        const CURRENT_USER = 'dandy'; // 模擬當前登入者

        // --- 模擬資料 ---
        const mockData = [
            { id: 1, transactionId: 'W250916100501', userId: 'player12345', isFirst: false, applicationTime: '2025-09-16 10:05:01', amount: 500.00, actualAmount: 495.00, status: '系統出款成功', operator: 'system', isOverdue: false, lockedBy: null, remark: '' },
            { id: 2, transactionId: 'W250916100212', userId: 'risk_user01', isFirst: true, applicationTime: '2025-09-16 10:02:12', amount: 50000.00, actualAmount: 0, status: '待審核', operator: '', isOverdue: false, lockedBy: null, remark: '' },
            { id: 3, transactionId: 'W250916095530', userId: 'vip_player888', isFirst: false, applicationTime: '2025-09-16 09:55:30', amount: 10000.00, actualAmount: 0, status: '審核中', operator: 'cathy', isOverdue: false, lockedBy: 'cathy', remark: '' },
            { id: 4, transactionId: 'W250916094015', userId: 'newbie_01', isFirst: true, applicationTime: '2025-09-16 09:40:15', amount: 100.00, actualAmount: 0, status: '審核失敗', operator: 'dandy', isOverdue: false, lockedBy: null, remark: '流水不足' },
            { id: 5, transactionId: 'W250916083000', userId: 'lucky_cat_777', isFirst: false, applicationTime: '2025-09-16 08:30:00', amount: 888.00, actualAmount: 0, status: '待審核', operator: '', isOverdue: true, lockedBy: null, remark: '' },
            { id: 6, transactionId: 'W250916081045', userId: 'auto_test_001', isFirst: false, applicationTime: '2025-09-16 08:10:45', amount: 200.00, actualAmount: 200.00, status: '自動提款', operator: 'system', isOverdue: false, lockedBy: null, remark: '' },
            { id: 7, transactionId: 'W250916075021', userId: 'error_prone_user', isFirst: false, applicationTime: '2025-09-16 07:50:21', amount: 3000.00, actualAmount: 0, status: '系統出款失敗', operator: 'system', isOverdue: false, lockedBy: null, remark: '第三方通道異常' },
            { id: 8, transactionId: 'W250916073011', userId: 'player777', isFirst: false, applicationTime: '2025-09-16 07:30:11', amount: 5000.00, actualAmount: 0, status: '系統出款中', operator: 'dandy', isOverdue: false, lockedBy: null, remark: '' },
        ];
        
        let currentData = [...mockData];
        let currentReviewId = null;
        let timeSortAsc = true;

        const tableBody = document.getElementById('applications-table-body');
        const reviewModal = document.getElementById('reviewModal');
        const remarkTextarea = document.getElementById('review-remark');
        const remarkCharCount = document.getElementById('remark-char-count');

        const statusOrder = { '待審核': 1, '審核中': 2, '審核失敗': 3, '系統出款中': 4, '系統出款成功': 5, '系統出款失敗': 6, '自動提款': 7 };

        const getStatusBadge = (status) => {
            const statusMap = {
                '待審核': 'status-pending', '審核中': 'status-reviewing', '審核失敗': 'status-review-failed',
                '系統出款中': 'status-processing', '系統出款成功': 'status-success', '系統出款失敗': 'status-failed', '自動提款': 'status-auto'
            };
            return `<span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${statusMap[status] || ''}">${status}</span>`;
        };

        const updateCounts = () => {
            document.getElementById('reviewing-count').textContent = mockData.filter(d => d.status === '審核中').length;
            document.getElementById('pending-count').textContent = mockData.filter(d => d.status === '待審核').length;
        };

        const renderTable = (data) => {
            // Sorting Logic
            const sortedData = [...data].sort((a, b) => {
                const statusDiff = statusOrder[a.status] - statusOrder[b.status];
                if (statusDiff !== 0) return statusDiff;
                const timeA = new Date(a.applicationTime).getTime();
                const timeB = new Date(b.applicationTime).getTime();
                return timeSortAsc ? timeA - timeB : timeB - timeA;
            });

            tableBody.innerHTML = sortedData.map(item => {
                let actionButtonHtml = '';
                if (item.status === '待審核') {
                    actionButtonHtml = `<button class="text-indigo-600 hover:text-indigo-900 start-review-btn" data-id="${item.id}">開始審核</button>`;
                } else if (item.status === '審核中') {
                    if (item.lockedBy === CURRENT_USER) {
                        actionButtonHtml = `<button class="text-green-600 font-semibold cursor-default">審核中 (您)</button>`;
                    } else {
                        actionButtonHtml = `<button class="text-orange-500 hover:text-orange-700 takeover-review-btn" data-id="${item.id}">接替審核</button>`;
                    }
                } else {
                    actionButtonHtml = '-';
                }

                return `
                    <tr class="${item.isOverdue ? 'bg-red-50' : 'hover:bg-gray-50'}">
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-medium">${actionButtonHtml}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">${getStatusBadge(item.status)}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm font-bold ${item.isOverdue ? 'text-red-600' : 'text-gray-500'}">${item.isOverdue ? '逾時訂單' : '-'}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.transactionId}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.userId}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm ${item.isFirst ? 'text-blue-600 font-semibold' : 'text-gray-500'}">${item.isFirst ? '是' : '否'}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.applicationTime}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900 font-medium">${item.amount.toLocaleString('en-US', { style: 'currency', currency: 'PHP' })}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-green-600 font-bold">${item.actualAmount > 0 ? item.actualAmount.toLocaleString('en-US', { style: 'currency', currency: 'PHP' }) : '-'}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${item.operator || '-'}</td>
                    </tr>
                `;
            }).join('');
        };
        
        const openModal = (modal) => modal.classList.remove('hidden');
        const closeModal = (modal) => modal.classList.add('hidden');
        
        const showToast = (message, type = 'success') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `toast ${type === 'success' ? 'toast-success' : type === 'error' ? 'toast-error' : 'toast-info'}`;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        };
        
        const openReviewModal = (id) => {
            const item = mockData.find(d => d.id === id);
            if (!item) return;

            currentReviewId = id;
            document.getElementById('modal-transactionId').textContent = item.transactionId;
            document.getElementById('modal-applicationTime').textContent = item.applicationTime;
            document.getElementById('modal-userId').textContent = item.userId;
            document.getElementById('modal-isFirst').textContent = item.isFirst ? '是' : '否';
            document.getElementById('modal-amount').textContent = item.amount.toLocaleString('en-US', { style: 'currency', currency: 'PHP' });
            remarkTextarea.value = item.remark;
            remarkCharCount.textContent = `${item.remark.length} / 255`;
            openModal(reviewModal);
        };

        const updateItemStatus = (id, newStatus, operator = '', lockedBy = null, remark = null) => {
            const itemIndex = mockData.findIndex(d => d.id === id);
            if (itemIndex > -1) {
                mockData[itemIndex].status = newStatus;
                if (operator) mockData[itemIndex].operator = operator;
                if (remark !== null) mockData[itemIndex].remark = remark;
                mockData[itemIndex].lockedBy = lockedBy;
                updateCounts();
                renderTable(currentData);
            }
        };

        tableBody.addEventListener('click', (e) => {
            const target = e.target;
            const id = parseInt(target.dataset.id);

            if (target.classList.contains('start-review-btn') || target.classList.contains('takeover-review-btn')) {
                const item = mockData.find(d => d.id === id);
                if (target.classList.contains('takeover-review-btn')) {
                    showToast(`您已從 ${item.lockedBy} 接替審核訂單 ${item.transactionId}`, 'info');
                }
                updateItemStatus(id, '審核中', '', CURRENT_USER);
                openReviewModal(id);
            }
        });

        document.getElementById('approveBtn').addEventListener('click', () => {
            updateItemStatus(currentReviewId, '系統出款中', CURRENT_USER, null, remarkTextarea.value);
            closeModal(reviewModal);
            showToast('訂單已核准，進入系統出款中。', 'success');
        });
        document.getElementById('rejectBtn').addEventListener('click', () => {
            if (!remarkTextarea.value.trim()){
                showToast('退回審核請務必填寫審核說明。', 'error');
                return;
            }
            updateItemStatus(currentReviewId, '審核失敗', CURRENT_USER, null, remarkTextarea.value);
            closeModal(reviewModal);
            showToast('訂單已退回。', 'info');
        });
        document.getElementById('cancelReviewBtn').addEventListener('click', () => {
            updateItemStatus(currentReviewId, '待審核', '', null);
            closeModal(reviewModal);
            showToast('已取消審核，訂單回到待審核狀態。', 'info');
        });
        document.getElementById('closeBtn').addEventListener('click', () => closeModal(reviewModal));

        remarkTextarea.addEventListener('input', () => {
            const len = remarkTextarea.value.length;
            if (len > 255) remarkTextarea.value = remarkTextarea.value.substring(0, 255);
            remarkCharCount.textContent = `${remarkTextarea.value.length} / 255`;
        });
        
        document.getElementById('searchButton').addEventListener('click', () => {
            // ... (omitted for brevity, search logic would be implemented here) ...
            showToast('已依照條件搜尋。', 'info');
            // For prototype, we just re-render all data
            renderTable(mockData);
        });
        
        document.getElementById('status-sort').addEventListener('click', () => {
            timeSortAsc = !timeSortAsc;
            document.getElementById('status-sort').textContent = `狀態 ${timeSortAsc ? '↓' : '↑'}`;
            renderTable(currentData);
        });

        // Initial render
        updateCounts();
        renderTable(currentData);
    });
    </script>
</body>
</html>
